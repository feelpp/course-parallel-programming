<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kokkos Hierarchical Parallelism :: Parallel Programming</title>
    <link rel="canonical" href="https://feelpp.github.io/parallel-programming/parallel-programming/kokkos/advanced-concepts/hierarchical-parallelism.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
<script>!function(l,p){if(l.protocol!==p&&l.host=="docs.antora.org"){l.protocol=p}else if(/\.gitlab\.io$/.test(l.host)){l.replace(p+"//docs.antora.org"+l.pathname.substr(l.pathname.indexOf("/",1))+l.search+l.hash)}}(location,"https:")</script>

<script src="../../../_/js/vendor/tabs-block-extension.js"></script>
<script src="../../../_/js/vendor/tabs-block-behavior.js"></script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true,
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },

  TeX: {
      Macros: {
      bold: ["{\\bf #1}",1],
      calTh: "{\\mathcal{T}_h}",
      card: ["{\\operatorname{card}(#1)}",1],
      card: ["{\\operatorname{card}(#1)}",1],
      Ck: ["{\\mathcal{C}^{#1}}",1],
      deformt: ["{\\mathbf{\\varepsilon(#1)}}",1],
      diam: "{\\operatorname{diam}}",
      dim: ["{\\operatorname{dim}(#1)}",1],
      disp: ["{\\mathbf{#1}}",1],
      domain: "{\\Omega}",
      ds: "",
      essinf: "{\\operatorname{ess}\\, \\operatorname{inf}}",
      F:"{\\mathcal{F}}",
      geo: "{\\mathrm{geo}}",
      Ich: ["{\\mathcal{I}^{#1}_{c,h}#2}",2],
      Id: "{\\mathcal{I}}",
      Ilag: ["{\\mathcal{I}^{\\mathrm{lag}}_{#1}}",1],
      jump: ["{[\\![ #1 ]\\!]}",1],
      n:"{\\mathbf{n}}",
      Ne: "{N_{\\mathrm{e}}}",
      Next: "{\\mathrm{n}}",
      nf: "{n_f}",
      ngeo: "{n_{\\mathrm{geo}}}",
      Nma: "{N_{\\mathrm{ma}}}",
      NN: "{\\mathbb N}",
      Nno: "{N_{\\mathrm{no}}}",
      Nso: "{N_{\\mathrm{so}}}",
      opdim: "{\\operatorname{dim}}",
      p: "{\\mathrm{p}}",
      P:"{\\mathcal{P}}",
      Pch: ["{P^{#1}_{c,h}}",1],
      Pcho: ["{P^{#1}_{c,h,0}}",1],
      Pk: ["{\\mathcal{P}^{#1}}",1],
      poly: ["{\\mathbb{#1}",1],
      poly: ["{\\mathbb{#1}}",1],
      prect: ["{\\left\\(#1\\right\\)}",1],
      q:"{\\mathbf{q}}",
      Qch: ["{Q^{#1}_{c,h}}",1],
      Qk: ["{\\mathcal{Q}^{#1}}",1],
      R: ["{\\mathbb{R}^{#1}}",1],
      RR: "{\\mathbb R}",
      set: ["{\\left\\{#1\\right\\}}",1],
      stresst: ["{\\mathbf{\\sigma(#1)}}",1],
      T:"{\\mathcal{T}}",
      tr: "{\\operatorname{tr}}",
      v:"{\\mathbf{v}}",
      vertiii: ["\\left\\vert\\kern-0.25ex\\left\\vert\\kern-0.25ex\\left\\vert #1 \\right\\vert\\kern-0.25ex\\right\\vert\\kern-0.25ex\\right\\vert",1]
  },
  extensions: ["mhchem.js"] 
  }
});
</script>
<!--<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-MML-AM_CHTML"></script>-->
<!-- <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script> -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS_CHTML'></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>-->

<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" integrity="sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.js" integrity="sha384-jmxIlussZWB7qCuB+PgKG1uLjjxbVVIayPJwi6cG6Zb4YKq0JIw+OMnkkEC7kYCq" crossorigin="anonymous"></script>-->
<script>var uiRootPath = '../../../_'</script>

  </head>
  <body class="article">
<header class="header">
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark navbar-template-project" style="border-top: 4px solid #9E9E9E">
        <div class="navbar-brand">
            <div class="navbar-item feelpp-logo">
                <a href="https://feelpp.github.io/parallel-programming">Parallel Programming</a>
            </div>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>

        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">
                <div class="navbar-item">
                    <a href="https://docs.feelpp.org/">Documentation Reference</a>
                </div>
                <div class="navbar-item has-dropdown is-hoverable download-item">
                    <div class="navbar-item"><a href="https://docs.feelpp.org/user/latest/install/index.html" class="download-btn">Get Feel++</a></div>
                </div>
                <div class="navbar-item">
                    <a class="navbar-brand"  href="https://www.cemosis.fr">
                        <img class="cemosis-logo"  src="../../../_/img/cemosis-logo.svg" alt="Cemosis logo"/>
                    </a>
                </div>
            </div>
        </div>
    </nav>
</header>
<div class="body">
<a href="#" class="menu-expand-toggle"></a>
<div class="nav-container" data-component="parallel-programming" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">Main</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Architectures</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_CPU.html">CPU Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_GPU.html">GPU Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_GPGPU.html">GPGPU Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_TPU.html">TPU Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_NPU.html">NPU Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_LPU.html">LPU Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_DPU.html">DPU Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_SIMD.html">SIMD Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_AMD_CUDA.html">AMD CUDA Architecture</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">MPI/OpenMP/Hybrid</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../PPChapter2_MPI.html">MPI (Message Passing Interface)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../PPChapter2_MPI_Boost.html">MPI Boost</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../PPChapter2_OpenMP.html">OpenMP (Open Multi-Processing)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../PPChapter2_OpenMP2.html">OpenMP more information</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../PPChapter2_Hybrid.html">Hybrid MPI with OpenMP</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Runtime Systems</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../PPChapter3.html">StarPU</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../PPChapter4.html">Specx</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">Kokkos</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Introduction</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../introduction/why-kokkos.html">Why Kokkos?</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../introduction/installation.html">Installation &amp; Setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../basic-concepts/index.html">Basic Concepts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../basic-concepts/views.html">Views</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../basic-concepts/execution-spaces.html">Execution Spaces</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../basic-concepts/memory-spaces.html">Memory Spaces</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../basic-concepts/mirrors.html">Mirrors</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../basic-concepts/memory-access-patterns.html">Memory Access Patterns</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Advanced Concepts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced-reductions.html">Advanced Reductions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="multidimensional-loops-and-data-structure.html">Multidimensional Loops and Data Structure</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="hierarchical-parallelism.html">Hierarchical Parallelism</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mpi-pgas.html">MPI and PGAS</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Main</span>
    <span class="version"></span>
  </div>
  <ul class="components">
      <li class="component">
        <a class="title" href="../../../feelpp-antora-ui/index.html">Antora Feel++ UI</a>
      </li>
      <li class="component is-current">
        <a class="title" href="../../index.html">Main</a>
      </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
  <button class="nav-toggle"></button>
    <a href="../../index.html" class="home-link"></a>
  <nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">Main</a></li>
    <li><a href="../index.html">Kokkos</a></li>
    <li><a href="index.html">Advanced Concepts</a></li>
    <li><a href="hierarchical-parallelism.html">Hierarchical Parallelism</a></li>
  </ul>
</nav>

  
    <div class="edit-this-page"><a href="https://github.com/feelpp/course-parallel-programming/edit/feature/kokkos/docs/modules/kokkos/pages/advanced-concepts/hierarchical-parallelism.adoc">Edit this Page</a></div>
  
  <div class="page-downloads">
  <span class="label">Download as</span>
  <ul class="download-options">
    <li>
      <a onclick="print(this)" href="#" data-toggle="tooltip" data-placement="left" title="Print to PDF"
         class="pdf-download">
        <img class="pdf-file-icon icon" src="../../../_/img/pdf.svg"/> .pdf
      </a>
    </li>
  </ul>
</div>
</div>

  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="3">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Kokkos Hierarchical Parallelism</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph text-justify">
<p>Kokkos' <strong>hierarchical parallelism</strong> is a paradigm that enables the exploitation of multiple levels of <strong>shared-memory parallelism</strong>, allowing developers to leverage increased parallelism in their computations for potential performance improvements. This framework supports various levels of parallelism, including thread teams, threads within a team, and vector lanes, which can be nested to create complex parallel structures.</p>
</div>
<div class="paragraph text-justify">
<p>The paradigm employs a two-tiered approach: an outer level, often implemented using a league of teams, which divides the overall workload into larger chunks, and an inner level, typically comprising threads within a team, which focuses on finer-grained parallelism within these chunks. <strong>Thread teams</strong>, a fundamental concept in Kokkos, represent collections of threads that can synchronize and share a common scratch pad memory.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hierarchical_parallelism"><a class="anchor" href="#_hierarchical_parallelism"></a>2. hierarchical parallelism</h2>
<div class="sectionbody">
<div class="paragraph text-justify">
<p>At the heart of Kokkos' <strong>hierarchical parallelism</strong> lies the ability to exploit multiple levels of <strong>shared-memory parallelism</strong>.
This approach allows developers to map complex algorithms to the hierarchical nature of modern hardware, from multi-core CPUs to many-core GPUs and leverage more parallelism in their computations, potentially leading to significant performance improvements. The framework supports various levels of parallelism, including thread teams, threads within a team, and vector lanes, which can be nested to create complex parallel structures [1][2][6].</p>
</div>
<div class="paragraph">
<p><strong>Similarities and Differences Between Outer and Inner Levels of Parallelism</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Outer Level (League)</strong>: The outermost level of parallelism, often referred to as the "league," typically corresponds to coarse-grained work distribution. This level is suitable for dividing large workloads across multiple compute units or NUMA domains.</p>
</li>
<li>
<p><strong>Inner Level (Team)</strong>: The inner level, or "team," represents a finer-grained parallelism within each league member. Teams often map to hardware-specific groupings like CUDA thread blocks or CPU core groups.</p>
</li>
<li>
<p><strong>Similarities</strong>: Both levels support parallel patterns such as for-loops, reductions, and scans, allowing for consistent programming models across levels.</p>
</li>
<li>
<p><strong>Differences</strong>: Inner levels have access to fast, shared memory resources and synchronization primitives, while outer levels are more independent and lack direct communication mechanisms.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Thread Teams</strong></p>
</div>
<div class="paragraph">
<p>Kokkos introduces the concept of <strong>thread teams</strong>, which organizes parallel work into a two-dimensional structure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>League</strong>: A collection of teams that can execute independently.</p>
</li>
<li>
<p><strong>Team</strong>: A group of threads that can synchronize and share resources.</p>
</li>
<li>
<p><strong>Thread</strong>: The basic unit of parallel execution within a team.</p>
<div class="literalblock">
<div class="content">
<pre>This hierarchical structure allows for efficient mapping of algorithms to hardware:</pre>
</div>
</div>
</li>
<li>
<p>On <strong>GPUs</strong>, <strong>teams</strong> often correspond to thread blocks, with threads mapping to CUDA threads or vectorized operations.</p>
</li>
<li>
<p>On <strong>CPUs</strong>, <strong>teams</strong> might represent groups of cores, with threads corresponding to individual CPU threads or SIMD lanes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Performance Improvement with Well-Coordinated Teams</strong></p>
</div>
<div class="paragraph">
<p>Well-coordinated teams can significantly boost performance by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Optimizing Memory Access</strong>: Teams can cooperatively load data into shared memory, reducing global memory accesses.</p>
</li>
<li>
<p><strong>Load Balancing</strong>: The two-level structure allows for dynamic work distribution, adapting to varying workloads across different parts of the computation.</p>
</li>
<li>
<p><strong>Hardware Utilization</strong>: By matching the team structure to hardware capabilities, Kokkos can achieve high occupancy and efficient resource usage [3].</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Example</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++">    struct HierarchicalParallelism {
        Kokkos::View&lt;double**&gt; matrix;
        HierarchicalParallelism(int N, int M) : matrix("matrix", N, M) {}
        KOKKOS_INLINE_FUNCTION
        void operator()(const Kokkos::TeamPolicy&lt;&gt;::member_type&amp; team_member) const {
            const int i = team_member.league_rank();
            Kokkos::parallel_for(Kokkos::TeamThreadRange(team_member, matrix.extent(1)),
            [&amp;] (const int j) {
                matrix(i, j) = i * matrix.extent(1) + j;
            });

            team_member.team_barrier();
            if (team_member.team_rank() == 0) {
            double sum = 0.0;
            Kokkos::parallel_reduce(Kokkos::TeamThreadRange(team_member, matrix.extent(1)),
                [&amp;] (const int j, double&amp; lsum) {
                lsum += matrix(i, j);
            }, sum);

            Kokkos::single(Kokkos::PerTeam(team_member), [&amp;] () {
                matrix(i, 0) = sum;
            });
            }
        }
    };

    int main(int argc, char* argv[]) {
        Kokkos::initialize(argc, argv);
        {
            const int N = 1000;
            const int M = 100;
            HierarchicalParallelism functor(N, M);
            Kokkos::parallel_for(Kokkos::TeamPolicy&lt;&gt;(N, Kokkos::AUTO), functor);
        }
        Kokkos::finalize();
        return 0
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hierarchical parallelism is implemented as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The top level uses <code>Kokkos::TeamPolicy</code> to parallelize on the rows of the matrix.</p>
</li>
<li>
<p><code>Kokkos::TeamThreadRange</code> is used to parallelize operations on columns within each team.</p>
</li>
<li>
<p><code>Kokkos::single</code> is used to ensure that some operations are performed only once per team.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scratch_memory"><a class="anchor" href="#_scratch_memory"></a>3. Scratch Memory</h2>
<div class="sectionbody">
<div class="paragraph text-justify">
<p><strong>Scratch memory</strong>, or <strong>scratch pad</strong>,  in Kokkos provides a powerful mechanism for managing temporary, fast-access storage within parallel kernels. This feature is crucial for optimizing performance in memory-bound applications [4]. The scratch pad is accessible only by threads within a team and has a lifetime equal to that of the team. It allows algorithms to load a workset into a shared space, enabling collaborative work among team members. This approach can significantly reduce global memory accesses, as intermediate results and frequently accessed data can be stored in the faster, more local scratch memory.</p>
</div>
<div class="paragraph">
<p><strong>Concept of Team and Thread Private Scratch Pads</strong></p>
</div>
<div class="paragraph">
<p>Kokkos offers two levels of scratch memory: <strong>Team Scratch</strong>,<strong>Thread Scratch</strong>. These scratch pads provide a flexible way to manage temporary data without relying on slower global memory accesses.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Team Scratch</strong>: Shared among all threads in a team, analogous to CUDA shared memory.</p>
</li>
<li>
<p><strong>Thread Scratch</strong>: Private to individual threads, useful for thread-local computations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Reducing Global Memory Accesses</strong></p>
</div>
<div class="paragraph">
<p>Scratch memory significantly reduces global memory traffic by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Data Reuse</strong>: Frequently accessed data can be loaded once into scratch memory and reused by multiple threads.</p>
</li>
<li>
<p><strong>Intermediate Results</strong>: Temporary computations can be stored in scratch memory, avoiding redundant global memory writes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>When to Use Scratch Memory</strong></p>
</div>
<div class="paragraph">
<p>Scratch memory is particularly beneficial in scenarios such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Stencil Computations</strong>: Where neighboring data elements are repeatedly accessed.</p>
</li>
<li>
<p><strong>Reduction Operations</strong>: For efficient partial sum calculations within teams.</p>
</li>
<li>
<p><strong>Data Gather-Scatter</strong>: When reorganizing data for more efficient processing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Using Scratch Memory and Necessary Barriers</strong></p>
</div>
<div class="paragraph">
<p>To effectively use scratch memory:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allocate scratch memory using <code>team_shmem_size()</code> or <code>thread_shmem_size()</code> in the execution policy.</p>
</li>
<li>
<p>Create scratch views within kernels using <code>ScratchView</code> or <code>team_scratch()</code>/<code>thread_scratch()</code>.</p>
</li>
<li>
<p>Use team barriers (<code>team.team_barrier()</code>) to ensure data consistency when sharing scratch memory among threads.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_unique_token"><a class="anchor" href="#_unique_token"></a>4. Unique Token</h2>
<div class="sectionbody">
<div class="paragraph text-justify">
<p><strong>Unique tokens</strong> in Kokkos provide a mechanism for thread-safe resource allocation and access in parallel environments [5]. This feature is particularly useful when multiple threads or teams need to access shared resources without conflicts. Unique tokens come in two scopes: Global and Instance. The Global scope provides identifiers that are unique across the entire execution space, while the Instance scope offers identifiers that are unique within a specific instance of parallel execution. This distinction allows developers to choose the appropriate level of uniqueness based on their specific requirements.</p>
</div>
<div class="paragraph">
<p><strong>Unique tokens</strong> ensure that each thread or team can acquire a distinct identifier or resource without conflicts. This mechanism is crucial for scenarios where threads need exclusive access to shared resources or need to perform thread-specific operations.</p>
</div>
<div class="paragraph">
<p><strong>Acquiring Per-Team Unique IDs</strong></p>
</div>
<div class="paragraph">
<p>To acquire unique IDs:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a <code>UniqueToken</code> object for the desired execution space.</p>
</li>
<li>
<p>Use the <code>acquire()</code> method within parallel kernels to obtain a unique identifier.</p>
</li>
<li>
<p>Release the token using <code>release()</code> when it&#8217;s no longer needed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Difference Between Global and Instance Scope</strong></p>
</div>
<div class="paragraph">
<p>Kokkos offers two scopes for unique tokens: <strong>Global Scope</strong> and <strong>Instance Scope</strong>. The choice of scope depends on the required level of uniqueness and the potential for resource contention in the application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Global Scope</strong>: Tokens are unique across all instances of <code>UniqueToken</code> in the application.</p>
</li>
<li>
<p><strong>Instance Scope</strong>: Tokens are unique only within a specific instance of <code>UniqueToken</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Example</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++">    Kokkos::initialize(argc, argv);
    {
        // Size of the array
        const int N = 100;
        // Kokkos view to store the results
        Kokkos::View&lt;int*&gt; results("results", N);
        // Create a UniqueToken (based on thread execution)
        Kokkos::Experimental::UniqueToken&lt;Kokkos::DefaultExecutionSpace&gt; unique_token;
        // Number of available threads
        const int num_threads = unique_token.size();
        std::cout &lt;&lt; "Number of threads: " &lt;&lt; num_threads &lt;&lt; std::endl;
        Kokkos::parallel_for("UniqueTokenExample", N, KOKKOS_LAMBDA(const int i) {
            // Get a unique identifier for this thread
            int token = unique_token.acquire();
            results(i) = token;
            unique_token.release(token);
        });
        // Copy the results to the host for display
        auto host_results = Kokkos::create_mirror_view_and_copy(Kokkos::HostSpace(), results);
        std::cout &lt;&lt; "Results: ";
        for (int i = 0; i &lt; N; ++i) {
            std::cout &lt;&lt; host_results(i) &lt;&lt; " ";
        }
        std::cout &lt;&lt; std::endl;
    }
    Kokkos::finalize();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Explanations:</p>
</div>
<div class="paragraph">
<p><strong>UniqueToken</strong> :
    <code>Kokkos::Experimental::UniqueToken</code> is used to generate unique identifiers in a parallel context.
    The <code>acquire()</code> method provides a unique identifier.
    The <code>release()</code> method releases this identifier so that it can be reused.</p>
</div>
<div class="paragraph">
<p><strong>Kokkos view</strong> :
    Data is stored in a view (<code>Kokkos::View</code>), which is an abstraction for managing data across different memory spaces.</p>
</div>
<div class="paragraph">
<p><strong>Parallel loop</strong> :
    <code>Kokkos::parallel_for</code> executes a loop in parallel.
    Each iteration gets a unique identifier via <code>unique_token.acquire()</code>.</p>
</div>
<div class="paragraph">
<p><strong>Copying results</strong>:
    Data is copied to the host using <code>Kokkos::create_mirror_view_and_copy</code> for display.</p>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references"><a class="anchor" href="#_references"></a>5. References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>[1] <a href="https://kokkos.org/kokkos-core-wiki/ProgrammingGuide/HierarchicalParallelism.html" class="bare">kokkos.org/kokkos-core-wiki/ProgrammingGuide/HierarchicalParallelism.html</a></p>
</li>
<li>
<p>[2] <a href="https://kokkos.org/kokkos-core-wiki/ProgrammingGuide/ProgrammingModel.html" class="bare">kokkos.org/kokkos-core-wiki/ProgrammingGuide/ProgrammingModel.html</a></p>
</li>
<li>
<p>[3] <a href="https://indico.mathrice.fr/event/303/attachments/598/799/cafe_calcul_kokkos_2021.pdf" class="bare">indico.mathrice.fr/event/303/attachments/598/799/cafe_calcul_kokkos_2021.pdf</a></p>
</li>
<li>
<p>[4] <a href="https://github.com/kokkos/kokkos/issues/1932" class="bare">github.com/kokkos/kokkos/issues/1932</a></p>
</li>
<li>
<p>[5] <a href="https://www.nersc.gov/assets/Uploads/Kokkos-training-Day2-NewUsers-Bruno-v2.pdf" class="bare">www.nersc.gov/assets/Uploads/Kokkos-training-Day2-NewUsers-Bruno-v2.pdf</a></p>
</li>
<li>
<p>[6] <a href="https://indico.math.cnrs.fr/event/12037/attachments/5040/8137/KokkosTutorial_04_HierarchicalParallelism.pdf" class="bare">indico.math.cnrs.fr/event/12037/attachments/5040/8137/KokkosTutorial_04_HierarchicalParallelism.pdf</a></p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title"><strong>Points to keep in mind</strong></div>
<div class="ulist">
<ul>
<li>
<p><strong>Hierarchal Parallelism</strong></p>
<div class="ulist">
<ul>
<li>
<p>Hierarchical work can be parallelized via hierarchical parallelism.</p>
</li>
<li>
<p>Hierarchical parallelism is leveraged using thread teams launched with a TeamPolicy.</p>
</li>
<li>
<p>Team “worksets” are processed by a team in nested parallel for (or reduce or scan) calls with a TeamThreadRange and ThreadVectorRange policy.</p>
</li>
<li>
<p>Execution can be restricted to a subset of the team with the single pattern using either a PerTeam or PerThread policy.</p>
</li>
<li>
<p>Teams can be used to reduce contention for global resources even in “flat” algorithms.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Scratch Space</strong></p>
<div class="ulist">
<ul>
<li>
<p>Scratch Memory can be use with the TeamPolicy to provide thread or team private memory.</p>
</li>
<li>
<p>Scratch memory exposes on-chip user managed caches (e.g. on NVIDIA GPUs)</p>
</li>
<li>
<p>The size must be determined before launching a kernel.</p>
</li>
<li>
<p>Two levels are available: large/slow and small/fast.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Tocken</strong></p>
<div class="ulist">
<ul>
<li>
<p>UniqueToken provides a thread safe portable way to divide thread or team specific resources</p>
</li>
<li>
<p>UniqueToken can be sized, such that it returns only ids within a specific range.</p>
</li>
<li>
<p>A Global scope UniqueToken can be acquired, allowing safe ids accross disjoint concurrent code sections.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Unique Token</strong></p>
<div class="ulist">
<ul>
<li>
<p>UniqueToken give a thread safe portable way to divide thread specific resources</p>
</li>
<li>
<p>UniqueToken can be sized to restrict ids to a range.</p>
</li>
<li>
<p>A Global UniqueToken is available.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer" style="border-top: 2px solid #e9e9e9; background-color: #fafafa; padding-bottom: 2em; padding-top: 2em;">
    <div class="container" style="display: flex; flex-direction: column; align-items: center; gap: 0.5em;">
        <div>
            <a href="https://www.cemosis.fr">
                <img src="../../../_/img/cemosis-logo.svg" alt="Cemosis logo" height="50">
            </a>
        </div>
        <span style="font-size: 0.8rem; color: #9e9e9e">© 2025 <a href="https://www.cemosis.fr" style="text-decoration: underline;">Cemosis</a>, Université de Strasbourg</span>
    </div>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>


<script async src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../../_/js/vendor/fontawesome.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>


<script type="text/javascript">
function toggleFullScreen() {
   var doc = window.document;
   var docEl = doc.documentElement;

   var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
   var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

   if(!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
       requestFullScreen.call(docEl);
   }
   else {
       cancelFullScreen.call(doc);
   }
}
</script>
  </body>
</html>
