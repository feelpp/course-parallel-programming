<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kokkos Multidimensional Loops and Data Structure :: Parallel Programming</title>
    <link rel="canonical" href="https://feelpp.github.io/parallel-programming/parallel-programming/kokkos/advanced-concepts/multidimensional-loops-and-data-structure.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
<script>!function(l,p){if(l.protocol!==p&&l.host=="docs.antora.org"){l.protocol=p}else if(/\.gitlab\.io$/.test(l.host)){l.replace(p+"//docs.antora.org"+l.pathname.substr(l.pathname.indexOf("/",1))+l.search+l.hash)}}(location,"https:")</script>

<script src="../../../_/js/vendor/tabs-block-extension.js"></script>
<script src="../../../_/js/vendor/tabs-block-behavior.js"></script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true,
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },

  TeX: {
      Macros: {
      bold: ["{\\bf #1}",1],
      calTh: "{\\mathcal{T}_h}",
      card: ["{\\operatorname{card}(#1)}",1],
      card: ["{\\operatorname{card}(#1)}",1],
      Ck: ["{\\mathcal{C}^{#1}}",1],
      deformt: ["{\\mathbf{\\varepsilon(#1)}}",1],
      diam: "{\\operatorname{diam}}",
      dim: ["{\\operatorname{dim}(#1)}",1],
      disp: ["{\\mathbf{#1}}",1],
      domain: "{\\Omega}",
      ds: "",
      essinf: "{\\operatorname{ess}\\, \\operatorname{inf}}",
      F:"{\\mathcal{F}}",
      geo: "{\\mathrm{geo}}",
      Ich: ["{\\mathcal{I}^{#1}_{c,h}#2}",2],
      Id: "{\\mathcal{I}}",
      Ilag: ["{\\mathcal{I}^{\\mathrm{lag}}_{#1}}",1],
      jump: ["{[\\![ #1 ]\\!]}",1],
      n:"{\\mathbf{n}}",
      Ne: "{N_{\\mathrm{e}}}",
      Next: "{\\mathrm{n}}",
      nf: "{n_f}",
      ngeo: "{n_{\\mathrm{geo}}}",
      Nma: "{N_{\\mathrm{ma}}}",
      NN: "{\\mathbb N}",
      Nno: "{N_{\\mathrm{no}}}",
      Nso: "{N_{\\mathrm{so}}}",
      opdim: "{\\operatorname{dim}}",
      p: "{\\mathrm{p}}",
      P:"{\\mathcal{P}}",
      Pch: ["{P^{#1}_{c,h}}",1],
      Pcho: ["{P^{#1}_{c,h,0}}",1],
      Pk: ["{\\mathcal{P}^{#1}}",1],
      poly: ["{\\mathbb{#1}",1],
      poly: ["{\\mathbb{#1}}",1],
      prect: ["{\\left\\(#1\\right\\)}",1],
      q:"{\\mathbf{q}}",
      Qch: ["{Q^{#1}_{c,h}}",1],
      Qk: ["{\\mathcal{Q}^{#1}}",1],
      R: ["{\\mathbb{R}^{#1}}",1],
      RR: "{\\mathbb R}",
      set: ["{\\left\\{#1\\right\\}}",1],
      stresst: ["{\\mathbf{\\sigma(#1)}}",1],
      T:"{\\mathcal{T}}",
      tr: "{\\operatorname{tr}}",
      v:"{\\mathbf{v}}",
      vertiii: ["\\left\\vert\\kern-0.25ex\\left\\vert\\kern-0.25ex\\left\\vert #1 \\right\\vert\\kern-0.25ex\\right\\vert\\kern-0.25ex\\right\\vert",1]
  },
  extensions: ["mhchem.js"] 
  }
});
</script>
<!--<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-MML-AM_CHTML"></script>-->
<!-- <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script> -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS_CHTML'></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>-->

<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" integrity="sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.js" integrity="sha384-jmxIlussZWB7qCuB+PgKG1uLjjxbVVIayPJwi6cG6Zb4YKq0JIw+OMnkkEC7kYCq" crossorigin="anonymous"></script>-->
<script>var uiRootPath = '../../../_'</script>

  </head>
  <body class="article">
<header class="header">
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark navbar-template-project" style="border-top: 4px solid #9E9E9E">
        <div class="navbar-brand">
            <div class="navbar-item feelpp-logo">
                <a href="https://feelpp.github.io/parallel-programming">Parallel Programming</a>
            </div>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>

        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">
                <div class="navbar-item">
                    <a href="https://docs.feelpp.org/">Documentation Reference</a>
                </div>
                <div class="navbar-item has-dropdown is-hoverable download-item">
                    <div class="navbar-item"><a href="https://docs.feelpp.org/user/latest/install/index.html" class="download-btn">Get Feel++</a></div>
                </div>
                <div class="navbar-item">
                    <a class="navbar-brand"  href="https://www.cemosis.fr">
                        <img class="cemosis-logo"  src="../../../_/img/cemosis-logo.svg" alt="Cemosis logo"/>
                    </a>
                </div>
            </div>
        </div>
    </nav>
</header>
<div class="body">
<a href="#" class="menu-expand-toggle"></a>
<div class="nav-container" data-component="parallel-programming" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">Main</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Architectures</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_CPU.html">CPU Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_GPU.html">GPU Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_GPGPU.html">GPGPU Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_TPU.html">TPU Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_NPU.html">NPU Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_LPU.html">LPU Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_DPU.html">DPU Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_SIMD.html">SIMD Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../architectures/PPChapter1_AMD_CUDA.html">AMD CUDA Architecture</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">MPI/OpenMP/Hybrid</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../PPChapter2_MPI.html">MPI (Message Passing Interface)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../PPChapter2_MPI_Boost.html">MPI Boost</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../PPChapter2_OpenMP.html">OpenMP (Open Multi-Processing)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../PPChapter2_OpenMP2.html">OpenMP more information</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../PPChapter2_Hybrid.html">Hybrid MPI with OpenMP</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Runtime Systems</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../PPChapter3.html">StarPU</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../PPChapter4.html">Specx</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">Kokkos</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Introduction</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../introduction/why-kokkos.html">Why Kokkos?</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../introduction/installation.html">Installation &amp; Setup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../basic-concepts/index.html">Basic Concepts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../basic-concepts/views.html">Views</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../basic-concepts/execution-spaces.html">Execution Spaces</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../basic-concepts/memory-spaces.html">Memory Spaces</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../basic-concepts/mirrors.html">Mirrors</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../basic-concepts/memory-access-patterns.html">Memory Access Patterns</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Advanced Concepts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="advanced-reductions.html">Advanced Reductions</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="multidimensional-loops-and-data-structure.html">Multidimensional Loops and Data Structure</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="hierarchical-parallelism.html">Hierarchical Parallelism</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mpi-pgas.html">MPI and PGAS</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Main</span>
    <span class="version"></span>
  </div>
  <ul class="components">
      <li class="component">
        <a class="title" href="../../../feelpp-antora-ui/index.html">Antora Feel++ UI</a>
      </li>
      <li class="component is-current">
        <a class="title" href="../../index.html">Main</a>
      </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
  <button class="nav-toggle"></button>
    <a href="../../index.html" class="home-link"></a>
  <nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">Main</a></li>
    <li><a href="../index.html">Kokkos</a></li>
    <li><a href="index.html">Advanced Concepts</a></li>
    <li><a href="multidimensional-loops-and-data-structure.html">Multidimensional Loops and Data Structure</a></li>
  </ul>
</nav>

  
    <div class="edit-this-page"><a href="https://github.com/feelpp/course-parallel-programming/edit/feature/kokkos/docs/modules/kokkos/pages/advanced-concepts/multidimensional-loops-and-data-structure.adoc">Edit this Page</a></div>
  
  <div class="page-downloads">
  <span class="label">Download as</span>
  <ul class="download-options">
    <li>
      <a onclick="print(this)" href="#" data-toggle="tooltip" data-placement="left" title="Print to PDF"
         class="pdf-download">
        <img class="pdf-file-icon icon" src="../../../_/img/pdf.svg"/> .pdf
      </a>
    </li>
  </ul>
</div>
</div>

  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="3">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Kokkos Multidimensional Loops and Data Structure</h1>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph text-justify">
<p>Kokkos offers powerful abstractions for handling <strong>multidimensional loops</strong>, <strong>data structures</strong>, and <strong>memory management</strong>. Here we will look at several key aspects of Kokkos, providing an overview of its capabilities and best practices for effective parallel programming.</p>
</div>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_multidimensional_loops_and_data_structures_in_kokkos"><a class="anchor" href="#_multidimensional_loops_and_data_structures_in_kokkos"></a>2. MultiDimensional Loops and Data Structures in Kokkos</h2>
<div class="sectionbody">
<div class="paragraph text-justify">
<p>Kokkos provides the <strong>MDRangePolicy</strong>, a sophisticated tool for parallelizing tightly nested loops across multiple dimensions. This policy allows developers to express complex multidimensional algorithms with ease and efficiency [5]. The <strong>MDRangePolicy</strong> can handle loops of 2 to 6 dimensions, making it suitable for a wide range of scientific and engineering applications [1].</p>
</div>
<div class="paragraph">
<p>To utilize the <strong>MDRangePolicy</strong>, one must specify the dimensionality of the loop using the Rank&lt;DIM&gt; template parameter. The syntax for creating an MDRangePolicy is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++">    Kokkos::parallel_for("Label",
    Kokkos::MDRangePolicy&lt;Kokkos::Rank&lt;3&gt;&gt;({0,0,0}, {N0,N1,N2}),
    KOKKOS_LAMBDA (int64_t i, int64_t j, int64_t k) {
        // Loop body
    }
    );</code></pre>
</div>
</div>
<div class="paragraph text-justify">
<p>In this example, we create a three-dimensional iteration space. The policy takes two required arguments: an initializer list for the beginning indices and another for the end indices[5]. Optionally, a third argument can be provided to specify tiling dimensions, which can be crucial for performance tuning[9].</p>
</div>
<div class="paragraph">
<p>A more elaborate example demonstrating the use of <strong>MDRangePolicy</strong> in the context of tensor operations is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++">    Kokkos::parallel_for("mdr_for_all_cells",
    Kokkos::MDRangePolicy&lt;Kokkos::Rank&lt;3&gt;&gt;({0,0,0}, {C,F,P}),
    KOKKOS_LAMBDA (const int c, const int f, const int p) {
        auto result = Kokkos::subview(outputField, c, f, p, Kokkos::ALL);
        auto left = Kokkos::subview(inputData, c, p, Kokkos::ALL, Kokkos::ALL);
        auto right = Kokkos::subview(inputField, c, f, p, Kokkos::ALL);
        for (int i=0; i&lt;D; ++i) {
        double tmp(0);
        for (int j=0; j&lt;D; ++j)
            tmp += left(i, j)*right(j);
        result(i) = tmp;
        }
    }
    );</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code snippet showcases how MDRangePolicy can be used in conjunction with subviews to perform complex tensor operations efficiently [9].</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_subviews_taking_slices_of_views_with_kokkos"><a class="anchor" href="#_subviews_taking_slices_of_views_with_kokkos"></a>3. Subviews: Taking Slices of Views with Kokkos</h2>
<div class="sectionbody">
<div class="paragraph text-justify">
<p><strong>Subviews</strong> in Kokkos provide a powerful mechanism for creating views that reference a subset of an existing view&#8217;s data. This capability is essential for efficient data manipulation and algorithm implementation.</p>
</div>
<div class="paragraph">
<p>The basic syntax for creating a subview is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++">    auto subview = Kokkos::subview(view, index1, index2, ...);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Kokkos offers flexible indexing options for <strong>subviews</strong>. You can use integer indices for single elements, Kokkos::ALL for entire dimensions, or Kokkos::pair&lt;int,int&gt; for ranges [9].</p>
</div>
<div class="paragraph">
<p>When working with <strong>subviews</strong>, it&#8217;s important to understand the view assignment rules. Kokkos ensures that view assignments are only allowed when the memory spaces are compatible and the shapes match. This strict checking helps prevent errors and ensures performance portability across different architectures.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_unmanaged_views_dealing_with_external_memory_with_kokkos"><a class="anchor" href="#_unmanaged_views_dealing_with_external_memory_with_kokkos"></a>4. Unmanaged Views: Dealing with External Memory with Kokkos</h2>
<div class="sectionbody">
<div class="paragraph text-justify">
<p>Unmanaged views in Kokkos provide a way to work with externally allocated memory, which is particularly useful when integrating Kokkos into existing codebases or when interfacing with external libraries [6].</p>
</div>
<div class="paragraph">
<p>To create an unmanaged view, you can use the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++">    Kokkos::View&lt;double*, Kokkos::HostSpace, Kokkos::MemoryTraits&lt;Kokkos::Unmanaged&gt;&gt;
    unmanaged_view(external_ptr, size);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unmanaged views are essential when you need to wrap externally allocated data into Kokkos views. This is often necessary when Kokkos is used in a library that receives pointers to data allocations as input [6].</p>
</div>
<div class="paragraph">
<p>When working with unmanaged views, it&#8217;s crucial to ensure that the lifetime of the external memory outlives the Kokkos view. Additionally, be cautious when using unmanaged views with device memory, as the memory management becomes the responsibility of the developer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_thread_safety_and_atomic_operations_with_kokkos"><a class="anchor" href="#_thread_safety_and_atomic_operations_with_kokkos"></a>5. Thread Safety and Atomic Operations with Kokkos</h2>
<div class="sectionbody">
<div class="paragraph text-justify">
<p>In parallel programming, ensuring <strong>thread safety</strong> is paramount. Kokkos provides <strong>atomic</strong> operations to handle situations where multiple threads might attempt to access and modify the same memory location concurrently [7].</p>
</div>
<div class="paragraph">
<p><strong>Atomic</strong> operations in Kokkos are particularly useful for implementing the scatter-add pattern, where multiple threads contribute to a shared result. While atomic operations provide thread safety, they can impact performance, especially under high contention.</p>
</div>
<div class="paragraph">
<p>The performance characteristics of atomic operations can vary significantly between CPUs and GPUs, and even among different data types. On CPUs, atomic operations on integers are generally faster than on floating-point types. On GPUs, the performance impact of atomics can be more pronounced, especially for global memory operations[7].</p>
</div>
<div class="paragraph">
<p>To use atomic operations in Kokkos, you can employ the Kokkos::atomic_* functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++">    Kokkos::atomic_add(&amp;value, increment);</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s important to note that while atomics provide a solution for thread safety, they should be used judiciously, as overuse can lead to performance bottlenecks.</p>
</div>
<div class="paragraph">
<p>Another example:</p>
</div>
<div class="paragraph">
<p>Atomics: the portable and thread-scalable solution</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++">    parallel_for(N, KOKKOS_LAMBDA(const size_t index) { const Something value = ...;
        const int bucketIndex = computeBucketIndex(value); Kokkos::atomic_add(&amp;_histogram(bucketIndex), 1);
    });</code></pre>
</div>
</div>
<div class="paragraph">
<p>Atomics are the only scalable solution to thread safety.
Locks are not portable.
Data replication is not thread scalable.</p>
</div>
<div class="paragraph">
<p><strong>Example</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++">    struct AtomicCounter {
        // Shared atomic counter
        Kokkos::Atomic&lt;int&gt; counter;
        // Constructor to initialize the counter
        AtomicCounter() : counter(0) {}
        // Function to increment the counter atomically
        KOKKOS_INLINE_FUNCTION
        void operator()(const int i) const {
            counter.fetch_add(1); // Atomically increment the counter
        }
    };

    int main(int argc, char* argv[]) {
        Kokkos::initialize(argc, argv);
        {
            const int numIterations = 1234567; // Number of increments
            AtomicCounter atomicCounter;
            // Launch a parallel for loop to increment the counter
            Kokkos::parallel_for("IncrementCounter", numIterations, atomicCounter);
            // Synchronize to ensure all increments are complete
            Kokkos::fence();
            // Output the final value of the counter
            std::cout &lt;&lt; "Final Counter Value: " &lt;&lt; atomicCounter.counter &lt;&lt; std::endl;
        }
        Kokkos::finalize();
        return 0;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Explanations: The <code>AtomicCounter</code> structure contains an atomic integer <code>counter</code> that will be incremented by multiple threads. The <code>Kokkos::Atomic</code> type ensures that operations on the counter are thread-safe.  The <code>operator()</code> function uses <code>fetch_add(1)</code> to atomically increment the <code>counter</code>. This operation guarantees that even if multiple threads attempt to update the counter simultaneously, each update will be executed safely without race conditions. After launching the parallel loop, <code>Kokkos::fence()</code> is called to ensure that all increments are completed before accessing the final value of the counter.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dualview_with_kokkos"><a class="anchor" href="#_dualview_with_kokkos"></a>6. DualView with Kokkos</h2>
<div class="sectionbody">
<div class="paragraph text-justify">
<p><strong>DualView</strong> is a powerful abstraction in Kokkos that manages mirrored data on both host and device. This is particularly valuable in heterogeneous computing environments where data needs to be accessed and modified on both the CPU and accelerators like GPUs. <strong>DualView</strong> simplifies the task of managing data movement between memory spaces, e.g., host and device.</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="#fragment101"><img src="../_images/kokkos-DualView.png" alt="kokkos DualView" width="320" height="150"></a>
</div>
</div>
<div class="paragraph">
<p>The primary motivation for <strong>DualView</strong> is to simplify data management and synchronization between host and device memory spaces. It automatically tracks which side (host or device) has been modified and needs synchronization, reducing the likelihood of errors due to out-of-sync data.</p>
</div>
<div class="paragraph">
<p>To create a DualView, you can use the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++">    Kokkos::DualView&lt;double*&gt; dual_data("label", size);</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>DualView</strong> provides methods like <strong>sync()</strong> and <strong>modify()</strong> to manage data coherency between <strong>host</strong> and <strong>device</strong>. This abstraction significantly simplifies the development of applications that need to work efficiently across different memory spaces, enhancing both productivity and performance portability.</p>
</div>
<div class="paragraph">
<p><strong>Kokkos</strong> offers a rich set of tools and abstractions for high-performance, portable parallel programming. By leveraging features like <strong>MDRangePolicy</strong>, <strong>subviews</strong>, <strong>unmanaged views</strong>, <strong>atomic operations</strong>, and <strong>DualView</strong>, developers can create efficient, scalable applications that perform well across a wide range of hardware architectures.</p>
</div>
<div class="paragraph">
<p><strong>Example</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++">    struct DualViewExample {
        // Define the dual view type
        using dual_view_type = Kokkos::DualView&lt;double*, Kokkos::LayoutLeft&gt;;
        // Function to initialize device view
        static void initialize(dual_view_type&amp; dv) {
            // Initialize the device view with values
            Kokkos::parallel_for("InitializeDeviceView", dv.d_view.extent(0), KOKKOS_LAMBDA(const int i) {
                dv.d_view(i) = static_cast&lt;double&gt;(i); // Assign values based on index
            });
            // Synchronize to update the host mirror
            dv.sync&lt;Kokkos::HostSpace&gt;();
        }

        // Function to print values from both views
        static void printValues(const dual_view_type&amp; dv) {
            std::cout &lt;&lt; "Host View Values: ";
            for (int i = 0; i &lt; dv.h_view.extent(0); ++i) {
                std::cout &lt;&lt; dv.h_view(i) &lt;&lt; " "; // Access host view
            }
            std::cout &lt;&lt; std::endl;
            std::cout &lt;&lt; "Device View Values: ";
            for (int i = 0; i &lt; dv.d_view.extent(0); ++i) {
                std::cout &lt;&lt; dv.d_view(i) &lt;&lt; " "; // Access device view
            }
            std::cout &lt;&lt; std::endl;
        }
    };

    int main(int argc, char* argv[]) {
        Kokkos::initialize(argc, argv);
        {
            const int N = 10; // Size of the DualView
            // Create a DualView with N elements
            DualViewExample::dual_view_type dv("MyDualView", N);
            // Initialize the device view
            DualViewExample::initialize(dv);
            // Print values from both views
            DualViewExample::printValues(dv);
        }
        Kokkos::finalize();
        return 0;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Explanations: This example effectively demonstrates how to use <strong>DualView</strong> in Kokkos to manage data across different memory spaces while ensuring synchronization between them.  The program starts by initializing the Kokkos runtime environment.  A <code>DualView</code> is defined as <code>dual_view_type</code>, which can hold data in both host and device memory.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references"><a class="anchor" href="#_references"></a>7. References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>[1] <a href="https://indico.math.cnrs.fr/event/12037/attachments/5040/8130/KokkosTutorial_03_MDRangeMoreViews.pdf" class="bare">indico.math.cnrs.fr/event/12037/attachments/5040/8130/KokkosTutorial_03_MDRangeMoreViews.pdf</a></p>
</li>
<li>
<p>[2] <a href="https://kokkos.org/kokkos-core-wiki/ProgrammingGuide/View.html" class="bare">kokkos.org/kokkos-core-wiki/ProgrammingGuide/View.html</a></p>
</li>
<li>
<p>[3] <a href="https://github.com/kokkos/kokkos/issues/549" class="bare">github.com/kokkos/kokkos/issues/549</a></p>
</li>
<li>
<p>[4] <a href="https://indico.math.cnrs.fr/event/12037/attachments/5040/8129/KokkosTutorial_02_ViewsAndSpaces.pdf" class="bare">indico.math.cnrs.fr/event/12037/attachments/5040/8129/KokkosTutorial_02_ViewsAndSpaces.pdf</a></p>
</li>
<li>
<p>[5] <a href="https://kokkos.org/kokkos-core-wiki/API/core/policies/MDRangePolicy.html" class="bare">kokkos.org/kokkos-core-wiki/API/core/policies/MDRangePolicy.html</a></p>
</li>
<li>
<p>[6] <a href="https://github.com/kokkos/kokkos-core-wiki/blob/main/docs/source/ProgrammingGuide/Interoperability.md" class="bare">github.com/kokkos/kokkos-core-wiki/blob/main/docs/source/ProgrammingGuide/Interoperability.md</a></p>
</li>
<li>
<p>[7] <a href="https://kokkos.org/kokkos-core-wiki/ProgrammingGuide/Machine-Model.html" class="bare">kokkos.org/kokkos-core-wiki/ProgrammingGuide/Machine-Model.html</a></p>
</li>
<li>
<p>[8] <a href="https://extremecomputingtraining.anl.gov/wp-content/uploads/sites/96/2024/08/ATPESC-2024-Track-2d-Talk-1-Turcksin-Kokkos.pdf" class="bare">extremecomputingtraining.anl.gov/wp-content/uploads/sites/96/2024/08/ATPESC-2024-Track-2d-Talk-1-Turcksin-Kokkos.pdf</a></p>
</li>
<li>
<p>[9] <a href="https://kokkos.org/kokkos-core-wiki/usecases/MDRangePolicy.html" class="bare">kokkos.org/kokkos-core-wiki/usecases/MDRangePolicy.html</a></p>
</li>
<li>
<p>[10] <a href="https://github.com/kokkos/kokkos/issues/102" class="bare">github.com/kokkos/kokkos/issues/102</a></p>
</li>
<li>
<p>[11] <a href="https://gensoft.pasteur.fr/docs/lammps/2020.03.03/Speed_kokkos.html" class="bare">gensoft.pasteur.fr/docs/lammps/2020.03.03/Speed_kokkos.html</a></p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title"><strong>Points to keep in mind</strong></div>
<div class="ulist">
<ul>
<li>
<p><strong>MDRangePolicy</strong></p>
<div class="ulist">
<ul>
<li>
<p>The MDRangePolicy allows parallelization of tightly nested loops of 2 to 6 dimensions.</p>
</li>
<li>
<p>It provides a more intuitive and potentially more efficient alternative to flattening multidimensional loops.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Subviews: Taking Slices of Views with Kokkos</strong></p>
<div class="ulist">
<ul>
<li>
<p>Subviews in Kokkos allow you to create views that reference a subset of an existing view&#8217;s data.</p>
</li>
<li>
<p>Similar capability as provided by Matlab, Fortran, or Python.</p>
</li>
<li>
<p>Prefer the use of auto for the type.
View&lt;int <strong>*</strong>&gt; v("v", N0, N1, N2);
auto sv = subview(v, i0, ALL, make_pair(start,end));</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Unmanaged Views</strong></p>
<div class="ulist">
<ul>
<li>
<p>Interoperability with externally allocated arrays.</p>
</li>
<li>
<p>No reference counting, memory not deallocated at destruction.</p>
</li>
<li>
<p>User is responsible for insuring proper dynamic and/or static extents, MemorySpace, Layout, etc.
View&lt;float**, LayoutRight, HostSpace&gt; v_unmanaged(raw_ptr , N0, N1);</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Atomic operations</strong></p>
<div class="ulist">
<ul>
<li>
<p>Atomic functions available on the host or the device (e.g. Kokkos::atomic add).</p>
</li>
<li>
<p>Use Atomic memory trait for atomic accesses on Views.
View&lt;int*&gt; v("v", N0);
View &lt;int*, MemoryTraits &lt;Atomic &gt;&gt; v_atomic = v;</p>
</li>
<li>
<p>Use ScatterView for scatter-add parallel pattern. ScatterView can transparently switch between Atomic and Data Replication based scatter algorithms.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Dual Views</strong></p>
<div class="ulist">
<ul>
<li>
<p>For managing data synchronization between host and device.</p>
</li>
<li>
<p>Helps in codes with no holistic view of data flow.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer" style="border-top: 2px solid #e9e9e9; background-color: #fafafa; padding-bottom: 2em; padding-top: 2em;">
    <div class="container" style="display: flex; flex-direction: column; align-items: center; gap: 0.5em;">
        <div>
            <a href="https://www.cemosis.fr">
                <img src="../../../_/img/cemosis-logo.svg" alt="Cemosis logo" height="50">
            </a>
        </div>
        <span style="font-size: 0.8rem; color: #9e9e9e">© 2025 <a href="https://www.cemosis.fr" style="text-decoration: underline;">Cemosis</a>, Université de Strasbourg</span>
    </div>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>


<script async src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../../_/js/vendor/fontawesome.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>


<script type="text/javascript">
function toggleFullScreen() {
   var doc = window.document;
   var docEl = doc.documentElement;

   var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
   var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

   if(!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
       requestFullScreen.call(docEl);
   }
   else {
       cancelFullScreen.call(doc);
   }
}
</script>
  </body>
</html>
